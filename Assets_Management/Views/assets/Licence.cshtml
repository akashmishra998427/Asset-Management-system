@{
    ViewData["Title"] = "Licence";
    Layout = "~/Views/Shared/ItLayout.cshtml";
}

<style>
    .upload-area {
        border: 2px dashed #007bff;
        border-radius: 10px;
        padding: 40px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        background: #f8f9fa;
    }

    .upload-area:hover {
        background: #e3f2fd;
        border-color: #0056b3;
    }

    .upload-area.dragover {
        background: #e3f2fd;
        border-color: #0056b3;
        transform: scale(1.02);
    }

    .upload-icon {
        font-size: 48px;
        color: #007bff;
        margin-bottom: 15px;
    }

    .table-container {
        max-height: 500px;
        overflow-y: auto;
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
    }

    .table-container table {
        margin-bottom: 0;
    }

    .table-container thead th {
        position: sticky;
        top: 0;
        z-index: 10;
        font-weight: 600;
        text-align: center;
        vertical-align: middle;
    }

    .table-container tbody td {
        border-color: #e9ecef;
    }

    .table-container tbody tr:nth-child(even) {
        background-color: #f8f9fa;
    }

    .table-container tbody tr:hover {
        background-color: #e3f2fd;
    }

    .select2-container .select2-selection--single {
        height: 45px !important;
    }

    .table-container {
        max-height: 500px;
        overflow-y: auto;
        overflow-x: auto; 
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        white-space: nowrap;  
    }
     
    .table-container table {
        margin-bottom: 0;
        border-collapse: collapse; 
    }

    .table-container th,
    .table-container td {
        border: 1px solid #dee2e6 !important; 
        text-align: center;
        vertical-align: middle;
        padding: 8px;
    }


</style>

<div class="container my-4">
    <!-- Header and Form in One Section -->
    <div class="card mb-4 border-0">
        <div class="card-header bg-gradient d-flex justify-content-between align-items-center"
             style="background: linear-gradient(90deg, #1e3c72, #2a5298); color: white;">

            <div>
                <h4 class="mb-0 fw-bold">📋 Software License</h4>
                <small class="text-light opacity-75">Manage your asset licenses efficiently</small>
            </div>
 
            <div>
                <button class="btn btn-primary me-2 toggle-btn active" data-view="form">
                    📝 Manual Entry
                </button>
                <button class="btn btn-secondary toggle-btn" data-view="upload">
                    📁 Upload Excel
                </button>
            </div>

        </div>

        <!-- Registration Form -->
        <div class="card-body" id="form-view">
            <form id="licenseForm">
                <div class="row g-3">
 
                    <div class="col-md-4">
                        <label class="form-label">Make <sup class="text-danger">*</sup> </label>
                        <select class="form-select" id="ddlMake" required>
                            <option value="">selet Make</option>
                            <option value="Adobe">Adobe</option>
                            <option value="CorelDRAW">CorelDRAW</option>
                            <option value="Microsoft">Microsoft</option>
                        </select>
                    </div>

                    <div class="col-md-4">
                        <label class="form-label">Software Type <sup class="text-danger">*</sup> </label>
                        <select class="form-select" id="ddlSoftwareType" required onchange="bindCategory()">
                            <option value="">Select Software Type</option>
                            <option value="Adobe">Adobe</option>
                            <option value="Corel">Corel</option>
                            <option value="Office">Office</option> 
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Software Category <sup class="text-danger">*</sup> </label>
                        <select class="form-select" id="ddlCategory" required>
                            <option value="">Select Software Category</option>
                             
                        </select>
                    </div>
@* 
                    <div class="col-md-4">
                        <label class="form-label">Version <sup class="text-danger">*</sup> </label>
                        <input type="text" class="form-control" name="txtVersion" id="txtVersion" required />
                    </div> *@

                    <div class="col-md-4">
                        <label class="form-label">Quantity <sup class="text-danger">*</sup> </label>
                        <input type="number" class="form-control" name="textQuantity" id="textQuantity" required />
                    </div>

                    <div class="col-md-4">
                        <label class="form-label">Licence Type <sup class="text-danger">*</sup> </label>
                        <select class="form-select" id="ddlLicenceType" required>
                            <option value="">Licence Type</option>
                            <option value="Cloud">Cloud</option>
                            <option value="LIC/SW Assurance"> LIC/SW Assurance </option>
                            <option value="OEM">OEM</option>
                            <option value="PAPER">PAPER</option>
                            <option value="Standard">Standard</option>
                        </select>
                    </div>

                    <div class="col-md-4">
                        <label class="form-label">Purchase Date <sup class="text-danger">*</sup> </label>
                        <input type="date" class="form-control" name="txtTurchaseDate" id="Quantity" required />
                    </div>

                    <div class="col-md-4">
                        <label class="form-label">Valid Up To <sup class="text-danger">*</sup> </label>
                        <input type="date" class="form-control" name="txtValidUpTo" id="textValidUpTo" required />
                    </div>

                    <div class="col-md-4">
                        <label class="form-label">Purchase Type <sup class="text-danger">*</sup> </label>
                        <select class="form-select" id="ddlPurchaseType" required>
                            <option value="">Select Purchase Type</option>
                            <option value="Aditi Computers Pvt. Ltd."> Aditi Computers Pvt. Ltd. </option>
                            <option value="Comparex India Pvt Ltd.">Comparex India Pvt Ltd.</option>
                            <option value="Dolphin Computers">Dolphin Computers</option>
                            <option value="Evangelist Technology Pvt. Ltd">Evangelist Technology Pvt. Ltd</option>
                            <option value="I2K2 India Pvt Ltd.">I2K2 India Pvt Ltd.</option>
                            <option value="Iris Unified Technology Ltd.">Iris Unified Technology Ltd.</option>
                            <option value="K.K Software Solutions Pvt.Ltd.">K.K Software Solutions Pvt.Ltd.</option>
                            <option value="O.A.Compserve Pvt.Ltd">O.A.Compserve Pvt.Ltd</option>
                            <option value="Sidhshree Computronics (P) Ltd.">Sidhshree Computronics (P) Ltd.</option>
                            <option value="Solicon Pvt Ltd.">Solicon Pvt Ltd.</option>
                            <option value="other">Other</option>
                        </select>
                    </div>

                    <div class="col-md-4">
                        <label class="form-label">Purchase Unit <sup class="text-danger">*</sup> </label>
                        <select class="form-select" id="ddlPurchaseUnit" required>
                             <option value="0" selected>Please Select Unit</option>
                        </select>
                    </div>

                    <div class="col-md-4">
                        <label class="form-label">Invoice No <sup class="text-danger">*</sup> </label>
                        <input type="text" class="form-control" id="txtInvoiceNo" required />
                    </div>

                    <div class="col-md-4">
                        <label class="form-label">Invoice Date <sup class="text-danger">*</sup> </label>
                        <input type="date" class="form-control" name="txtInvoiceDate" required />
                    </div>

                    <div class="col-md-4">
                        <label class="form-label">Price (INR) <sup class="text-danger">*</sup> </label>
                        <input type="number" class="form-control" id="txtPrice" required />
                    </div>

                    <div class="col-md-4">
                        <label class="form-label">Po Number <sup class="text-danger">*</sup> </label>
                        <input type="text" class="form-control" id="txtPoNo" required />
                    </div>

                    <div class="col-md-4">
                        <label class="form-label">Po Date <sup class="text-danger">*</sup> </label>
                        <input type="date" class="form-control" id="txtPoDate" required />
                    </div>

                    <div class="col-md-4">
                        <label class="form-label">Upload Invoice <sup class="text-danger">*</sup> </label>
                        <input type="file" class="form-control" id="txtFile" required />
                    </div>

                </div>
                <div class="mt-4 d-flex justify-content-end">
                    <button type="submit" id="btnRegisterLsnc" class="btn btn-success px-5">Register License</button>
                </div>
            </form>
        </div>

        <!-- Bulk Upload -->
        <div class="card-body d-none" id="upload-view">
            <!-- Drag & Drop Upload Area -->
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">📁</div>
                <h5 class="text-primary mb-3">Upload Excel File</h5>
                <p class="text-muted mb-3">
                    <strong>Click here</strong> to select a file or <strong>drag and drop</strong> your Excel file
                </p>
                <p class="small text-muted">
                    Supported formats: .xlsx, .xls, .csv (Max size: 10MB)
                </p>
            </div>

            <input type="file" id="excelFile" class="d-none" accept=".xlsx,.xls,.csv" />
           
           
            <div id="previewTable" class="mt-2"></div>

            <!-- Save & Cancel Buttons -->
            <div class="mt-3 d-flex justify-content-end" style="gap:15px">
                <button class="btn btn-success d-none" id="uploadExcelBtn">
                    <i class="fas fa-upload me-1"></i> Save
                </button>
                <button class="btn btn-danger d-none" id="cancelUploadBtn">
                    <i class="fas fa-times me-1"></i> Cancel
                </button>
            </div>
        </div>
    </div>
</div>

<script>
 
    let $uploadedFile = null;
    let $excelFile = $('#excelFile');
    let $uploadExcelBtn = $('#uploadExcelBtn');

    $(document).ready(function () {
        BindPurchaseUnit();
        $('#ddlPurchaseUnit').select2();
    });

    // Toggle views
    $(document).on("click", ".toggle-btn", function () {
        
        $(".toggle-btn").removeClass("btn-primary active").addClass("btn-secondary");
        $(this).removeClass("btn-secondary").addClass("btn-primary active");

        if ($(this).data("view") === "form") {
            $("#form-view").removeClass("d-none");
            $("#upload-view").addClass("d-none");
        } else {
            $("#upload-view").removeClass("d-none");
            $("#form-view").addClass("d-none");
        }
        // bindCategory()
    });

    $("#uploadArea").click(function() {
        $("#excelFile").click();
    });

    $("#uploadArea").on({
        dragover: function(e) {
            e.preventDefault();
            $(this).addClass("dragover");
        },
        dragleave: function(e) {
            e.preventDefault();
            $(this).removeClass("dragover");
        },
        drop: function(e) {
            e.preventDefault();
            $(this).removeClass("dragover");

            const files = e.originalEvent.dataTransfer.files;
            if (files.length > 0) {
                const file = files[0];
                handleFileSelection(file);
            }
        }
    });

    $("#licenseForm").submit(function (e) {
        e.preventDefault();
        const formData = $(this).serializeArray();
        const licenseData = {};
        formData.forEach(f => licenseData[f.name] = f.value);

        console.log("License Data:", licenseData);

        $.post("/License/Register", licenseData, function (res) {
            alert("License registered successfully!");
            $("#licenseForm")[0].reset();
        });
    });

    $("#excelFile").change(function (e) {
        let file = e.target.files[0];
        if (!file) return;
        handleFileSelection(file);
    });
     
    function handleFileSelection(file) {
        const validTypes = ['application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', 'application/vnd.ms-excel', 'text/csv'];
        const maxSize = 10 * 1024 * 1024;

        if (!validTypes.includes(file.type) && !file.name.match(/\.(xlsx|xls|csv)$/i)) {
            alert("Please select a valid Excel or CSV file.");
            return;
        }

        if (file.size > maxSize) {
            alert("File size should be less than 10MB.");
            return;
        }

        $("#uploadArea").addClass("d-none");
        $("#uploadExcelBtn").removeClass("d-none");
        $("#cancelUploadBtn").removeClass("d-none");

        let reader = new FileReader();
        reader.onload = function (evt) {
            let data = evt.target.result;
            let workbook = XLSX.read(data, { type: "binary" });
            let firstSheet = workbook.SheetNames[0];
            let excelData = XLSX.utils.sheet_to_json(workbook.Sheets[firstSheet], { header: 1 });

            let html = `<div class="table-container">
                <table class='table table-striped table-hover mb-0 table table-bordered border-primary'>
                    <thead>
            `;

            if (excelData.length > 0) {
                let headerRow = excelData[0];
                let colCount = headerRow.length;

                html += "<tr>";
                headerRow.forEach((header) => {
                    html += `<th><span>${header || ''}</span></th>`;
                });
                html += "</tr></thead><tbody>";

                excelData.slice(1).forEach((row) => {
                    html += `<tr>`;
                    for (let i = 0; i < colCount; i++) {
                        let cellValue = row[i] !== undefined ? row[i] : '';
                        html += `<td>${cellValue}</td>`;
                    }
                    html += "</tr>";
                });
            }

            html += "</tbody></table></div>";

            html += `<div class="mt-3 p-3 bg-light rounded">
                <div class="row text-center">
                    <div class="col-md-3">
                        <div class="fw-bold text-dark">${file.name}</div>
                        <small class="text-muted">File Name</small>
                    </div>
                    <div class="col-md-3">
                        <div class="text-primary fw-bold fs-5">${excelData.length - 1}</div>
                        <small class="text-muted">Total Rows</small>
                    </div>
                    <div class="col-md-3">
                        <div class="text-success fw-bold fs-5">${excelData[0] ? excelData[0].length : 0}</div>
                        <small class="text-muted">Total Columns</small>
                    </div>
                    <div class="col-md-3">
                        <div class="text-info fw-bold fs-5">${(file.size / 1024).toFixed(1)} KB</div>
                        <small class="text-muted">File Size</small>
                    </div>
                </div>
            </div>`;
            $("#previewTable").html(html);
        };
        reader.readAsBinaryString(file);
    }

    $("#cancelUploadBtn").on("click", function () {
        $("#previewTable").empty();
        $("#uploadArea").removeClass("d-none");
        $("#uploadExcelBtn").addClass("d-none");
        $("#cancelUploadBtn").addClass("d-none");
        $("#excelFile").val("");  
    });


    function BindPurchaseUnit() {
        $.ajax({
            url: '/Assets/BindPuchaseUnit',
            type: "GET",
            dataType: "json",  
            success: function (res) {
                let options = `<option value="">Select Purchase Unit</option>`;

                $.each(res, function (i, v) {
                    options += `<option value="${v.compcode}">${v.N_compcode.trim()}</option>`;
                });

                $("#ddlPurchaseUnit").html(options);
            },
            error: function (xhr, status, error) {
                console.error(`Error binding purchase dropdown: ${error}, ${status}`);
            }
        });
    }

    $excelFile.on('change',function(){
       $uploadedFile = this.files[0];
    })

    $('#uploadExcelBtn').on('click', function () {
        let uploadedFile = $excelFile[0].files[0];

        if (!uploadedFile) {
            fireSweetAlert("Please select a file first.", 'error');
            return;
        }

        let $uploadExcelBtn = $(this);
        $uploadExcelBtn.prop('disabled', true);
        $uploadExcelBtn.html('<i class="fas fa-spinner fa-spin me-1"></i> Processing...');

        let formData = new FormData();
        formData.append("ExcelSheet", uploadedFile);

        $.ajax({
            url: '/Assets/UploadLicenceBulk',
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function (response) {
                if (response.success) {
                    fireSweetAlert(`✅ Success: ${response.message}`, 'success');
                } else {
                    fireSweetAlert(`❌ Error: ${response.message}`, 'error');
                }
            },
            error: function (xhr, status, error) {
                console.error('AJAX Error:', error);
                fireSweetAlert('Error uploading file. Please try again.', 'error');
            },
            complete: function () {
                $uploadExcelBtn.prop('disabled', false);
                $uploadExcelBtn.html('<i class="fas fa-upload me-1"></i> Save');
            }
        });
    }); 

    $('#btnRegisterLsnc').on('click', function(e) {
        e.preventDefault(); 
        const make = $('#ddlMake').val();
        const softwareType = $('#ddlSoftwareType').val();
        // const version = $('#txtVersion').val();
        const quantity = $('#textQuantity').val();
        const licenseType = $('#ddlLicenceType').val();
        const purchaseDate = $('input[name="txtTurchaseDate"]').val();
        const validUpTo = $('#textValidUpTo').val();
        const purchaseType = $('#ddlPurchaseType').val();
        const purchaseUnit = $('#ddlPurchaseUnit').val();
        const invoiceNo = $('#txtInvoiceNo').val();
        const SoftwareCategory = $('#ddlCategory').val();
        const invoiceDate = $('input[name="txtInvoiceDate"]').val();
        const price = $('#txtPrice').val();
        const poNo = $('#txtPoNo').val();
        const poDate = $('#txtPoDate').val();
        const fileInput = $('#txtFile')[0];


        // console.log(make ,softwareType , quantity ,licenseType || SoftwareCategory ||
        //     !purchaseDate || !validUpTo || !purchaseType || !purchaseUnit ||
        //     !invoiceNo || !invoiceDate || !price || !poNo || !poDate || !fileInput.files[0])

        if (!make || !softwareType || !quantity || !licenseType || !SoftwareCategory ||
            !purchaseDate || !validUpTo || !purchaseType || !purchaseUnit ||
            !invoiceNo || !invoiceDate || !price || !poNo || !poDate || !fileInput.files[0]) {
            fireSweetAlert('Please fill all required fields', 'error');
            return;
        }

        const formData = new FormData();

        formData.append('InvoiceFile', fileInput.files[0]);

        formData.append('Make', make);
        formData.append('Software_Type', softwareType);
        // formData.append('Version', version);
        formData.append('Quantity', quantity);
        formData.append('License_Type', licenseType);
        formData.append('PurchaseDate', purchaseDate);
        formData.append('ValidUpTo', validUpTo);
        formData.append('PurchaseType', purchaseType);
        formData.append('CompneyName', $('#ddlPurchaseType option:selected').text());  
        formData.append('PurchaseUnit', purchaseUnit);
        formData.append('InviceNo', invoiceNo);
        formData.append('InvoiceDate', invoiceDate);
        formData.append('Price', price);
        formData.append('PoNo', poNo);
        formData.append('PoDate', poDate);
        formData.append('SoftwareCategory',SoftwareCategory);

        const $btn = $(this);
        const originalText = $btn.html();
        $btn.prop('disabled', true);
        $btn.html('<i class="fas fa-spinner fa-spin me-1"></i> Processing...');

        $.ajax({
            url: '/Assets/RegisterLicense',
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                if (response.success) {
                    fireSweetAlert('✅ License registered successfully!', 'success');
                    $('#licenseForm')[0].reset();
                    $('#ddlPurchaseUnit').val('').trigger('change'); 
                } else {
                    fireSweetAlert(`❌ Error: ${response.message}`, 'error');
                }
            },
            error: function(xhr, status, error) {
                console.error('AJAX Error:', error);
                let errorMessage = 'Error registering license. Please try again.';

                if (xhr.responseJSON && xhr.responseJSON.message) {
                    errorMessage = xhr.responseJSON.message;
                }

                fireSweetAlert(`❌ ${errorMessage}`, 'error');
            },
            complete: function() { 
                $btn.prop('disabled', false);
                $btn.html(originalText);
            }
        });
    });
     

    // function bindCategory()
    // {
    //     $.ajax({
    //         url:'/Assets/BindSoftwareCategory',
    //         type:'GET',
    //         data:{SoftwareType:$('#ddlSoftwareType').val()},
    //         success:function(data){
    //             $('#ddlCategory').empty();
    //             let options = `<option value='0'>Select Software Category</option>`
    //             $.each(data,function(i,v){
    //                 options += `<option value="${v.SwName}">${v.SwName}</option>`
    //             })
    //             $('#ddlCategory').append(options)
    //             $('#ddlCategory').select2()

    //         },
    //         error:function(xhr,status,error)
    //         {
    //             console.log(`${xhr},${status},${error}`)
    //         }
    //     })
    // }

    function bindCategory() {
        $.ajax({
            url: '/Assets/BindSoftwareCategory',
            type: 'GET',
            data: { SoftwareType: $('#ddlSoftwareType').val() },
            dataType: 'json',  // <-- ✅ This ensures automatic parsing
            success: function(data) {
                $('#ddlCategory').empty();
                let options = `<option value='0'>Select Software Category</option>`;
                $.each(data, function(i, v) {
                    options += `<option value="${v.SwName}">${v.SwName}</option>`;
                });
                $('#ddlCategory').append(options);
                $('#ddlCategory').select2();
            },
            error: function(xhr, status, error) {
                console.log(`${xhr}, ${status}, ${error}`);
            }
        });
    }


</script>